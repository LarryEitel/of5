"use strict";(function(e){e.userRoles={"public":1,user:2,admin:4},e.accessLevels={"public":7,anon:1,user:6,admin:4}})("undefined"==typeof exports?this.routingConfig={}:exports),angular.module("ofApp",["restangular","ngCookies","ui.bootstrap","google-maps"]),angular.module("ofApp").config(["$httpProvider",function(e){e.defaults.headers.common.Authorization="Basic admin@orgtec.com:xxxxxx",e.defaults.headers.post["Content-Type"]="application/x-www-form-urlencoded"}]),angular.module("ofApp").config(["RestangularProvider",function(e){e.setBaseUrl("http://exi.xchg.com/api"),e.setListTypeIsArray(!1),e.setResponseExtractor(function(e,t,o){return"users"===o&&"getList"===t&&localStorage.setItem("lsuser",JSON.stringify(e._items[0])),e})}]),angular.module("ofApp").config(["$routeProvider","$locationProvider","$httpProvider",function(e,t,o){var r=routingConfig.accessLevels;e.when("/plcs",{templateUrl:"views/plcs.html",controller:"PlcsCtrl",access:r.anon}),e.when("/plc/:id/edit",{templateUrl:"views/plc-form.html",controller:"PlcFormCtrl",access:r.anon}),e.when("/plc/insert",{templateUrl:"views/plc-form.html",controller:"PlcFormCtrl",access:r.anon}),e.when("/plc/:id",{templateUrl:"views/plc-view.html",controller:"PlcViewCtrl",access:r.anon}),e.when("/",{templateUrl:"views/partials/home.html",controller:"HomeCtrl",access:r.user}),e.when("/login",{templateUrl:"views/partials/login.html",controller:"LoginCtrl",access:r.anon}),e.when("/logout",{templateUrl:"views/partials/logout.html",controller:"LogoutCtrl",access:r.user}),e.when("/register",{templateUrl:"views/partials/register.html",controller:"RegisterCtrl",access:r.anon}),e.when("/private",{templateUrl:"/partials/private",controller:"PrivateCtrl",access:r.user}),e.when("/admin",{templateUrl:"/partials/admin",controller:"AdminCtrl",access:r.admin}),e.when("/404",{templateUrl:"views/partials/404.html",access:r.public}),e.otherwise({redirectTo:"/404"});var n=["$location","$q",function(e,t){function o(e){return e}function r(o){return 401===o.status?(e.path("/login"),t.reject(o)):t.reject(o)}return function(e){return e.then(o,r)}}];o.responseInterceptors.push(n)}]),angular.module("ofApp").run(["$rootScope","$location","Auth",function(e,t,o){e.$on("$routeChangeStart",function(r,n){e.error=null,o.authorize(n.access)||o.isLoggedIn()||t.path("/login")}),e.appInitialized=!0}]),angular.module("ofApp").factory("Auth",["Restangular","$http","$rootScope","$cookieStore",function(e,t,o){var r=routingConfig.accessLevels,n=routingConfig.userRoles;return localStorage.getItem("lsuser")&&(o.user=JSON.parse(localStorage.getItem("lsuser"))),o.accessLevels=r,o.userRoles=n,{authorize:function(e,t){return void 0!==t?!0:!1},isLoggedIn:function(e){return void 0===e?e=o.user:void 0},register:function(e,o,r){t.post("/register",e).success(o).error(r)},login:function(t,r){var n=e.all("users");n.getList({where:JSON.stringify({uNam:t.username})}).then(function(e){e._items.length&&(t=e._items[0],o.user=t,r(t))},function(){$location.path("/")},function(){o.error="Failed to login"})},logout:function(e,r){t.post("/logout").success(function(){o.user.uNam="",e()}).error(r)},accessLevels:r,userRoles:n}}]),angular.module("ofApp").controller("AppCtrl",["$rootScope","$scope","$location","Auth",function(e,t,o,r){t.getUserRoleText=function(e){return _.invert(r.userRoles)[e]},t.logout=function(){r.logout(function(){o.path("/login")},function(){e.error="Failed to logout"})}}]),angular.module("ofApp").controller("LoginCtrl",["$rootScope","$scope","$location","Auth",function(e,t,o,r){e.activeNavItem="login",t.rememberme=!0,t.login=function(){localStorage.removeItem("lsuser"),r.login({username:t.username,password:t.password,rememberme:t.rememberme},function(){o.path("/")},function(){e.error="Failed to login"})}}]),angular.module("ofApp").controller("LogoutCtrl",["$rootScope","$location",function(e,t){localStorage.removeItem("lsuser"),delete e.user,t.path("/")}]),angular.module("ofApp").controller("HomeCtrl",["$rootScope",function(e){e.activeNavItem="home"}]),angular.module("ofApp").controller("RegisterCtrl",["$rootScope","$scope","$location","Auth",function(e,t,o,r){e.activeNavItem="register",t.role=routingConfig.userRoles.user,t.register=function(){r.register({username:t.username,password:t.password,role:t.role},function(t){e.user=t,o.path("/")},function(t){e.error=t})}}]),angular.module("ofApp").controller("PrivateCtrl",["$rootScope",function(e){e.activeNavItem="private"}]),angular.module("ofApp").controller("AdminCtrl",["$rootScope","$scope","Users",function(e,t,o){e.activeNavItem="admin",t.loading=!0,o.getAll(function(e){t.users=e,t.loading=!1},function(){e.error="Failed to fetch users.",t.loading=!1})}]),angular.module("ofApp").directive("accessLevel",["$rootScope","Auth",function(e,t){return{restrict:"A",link:function(o,r,n){var a=r.css("display");e.$watch("user.role",function(){t.authorize(n.accessLevel)?r.css("display",a):r.css("display","none")})}}}]).directive("autoFillableField",function(){return{restrict:"A",require:"?ngModel",link:function(e,t,o,r){setInterval(function(){""===t.val()&&r.$pristine||e.$apply(function(){r.$setViewValue(t.val())})},300)}}}),function(){function e(e,t){return 1e-6>Math.abs(e-t)}var t=function(){function t(t){var r=null,n=[],a=[],i=[],l=angular.extend({},o,t),s=this,c=null;this.center=t.center,this.zoom=l.zoom,this.draggable=l.draggable,this.dragging=!1,this.selector=l.container,this.markers=[],this.options=l.options,this.draw=function(){if(null!==s.center)if(null===r)r=new google.maps.Map(s.selector,angular.extend(s.options,{center:s.center,zoom:s.zoom,draggable:s.draggable,mapTypeId:google.maps.MapTypeId.ROADMAP})),google.maps.event.addListener(r,"dragstart",function(){s.dragging=!0}),google.maps.event.addListener(r,"idle",function(){s.dragging=!1}),google.maps.event.addListener(r,"drag",function(){s.dragging=!0}),google.maps.event.addListener(r,"zoom_changed",function(){s.zoom=r.getZoom(),s.center=r.getCenter()}),google.maps.event.addListener(r,"center_changed",function(){s.center=r.getCenter()}),a.length&&angular.forEach(a,function(e){google.maps.event.addListener(r,e.on,e.handler)});else{google.maps.event.trigger(r,"resize");var t=r.getCenter();e(t.lat(),s.center.lat())&&e(t.lng(),s.center.lng())||r.setCenter(s.center),r.getZoom()!==s.zoom&&r.setZoom(s.zoom)}},this.fit=function(){if(r&&n.length){var e=new google.maps.LatLngBounds;angular.forEach(n,function(t){e.extend(t.getPosition())}),r.fitBounds(e)}},this.on=function(e,t){a.push({on:e,handler:t})},this.addMarker=function(e,t,o,a,i,l,u,g,d,p){if(null===s.findMarker(e,t)){var m,f,h,v,w,$="img/map/sprites/";10>a?(h=$+"sprite_1.png",f=12,v=(a-1)*f,w=i*m):100>a?(h=$+"sprite_2.png",f=16,v=(a-10)*f,w=i*m):(h=$+"sprite_3.png",f=20,v=(a-100)*f,w=i*m),w&&(w+=1),a&&void 0!==i&&(o=new google.maps.MarkerImage(h,new google.maps.Size(f,12),new google.maps.Point(v,w),new google.maps.Point(0,0)));var b=new google.maps.Marker({position:new google.maps.LatLng(e,t),map:r,draggable:p,icon:o});if(null!==l){var y=new google.maps.InfoWindow({content:l});google.maps.event.addListener(b,"click",function(){null!==c&&c.close(),y.open(r,b),c=y})}return n.unshift(b),s.markers.unshift({lat:e,lng:t,draggable:!1,icon:o,infoWindowContent:l,label:u,url:g,thumbnail:d}),b}},this.findMarker=function(t,o){for(var r=0;n.length>r;r++){var a=n[r].getPosition();if(e(a.lat(),t)&&e(a.lng(),o))return n[r]}return null},this.findMarkerIndex=function(t,o){for(var r=0;n.length>r;r++){var a=n[r].getPosition();if(e(a.lat(),t)&&e(a.lng(),o))return r}return-1},this.addInfoWindow=function(e,t,o){var r=new google.maps.InfoWindow({content:o,position:new google.maps.LatLng(e,t)});return i.push(r),r},this.hasMarker=function(e,t){return null!==s.findMarker(e,t)},this.getMarkerInstances=function(){return n},this.removeMarkers=function(e){var t=this;angular.forEach(e,function(e){var o=e.getPosition(),r=o.lat(),a=o.lng(),i=t.findMarkerIndex(r,a);n.splice(i,1),t.markers.splice(i,1),e.setMap(null)})}}var o={zoom:8,draggable:!1,container:null};return t}(),o=angular.module("google-maps",[]);o.directive("googleMap",["$log","$timeout","$filter",function(o,r){var n=function(e){var t=e.map;self.addInfoWindow=function(e,o,r){t.addInfoWindow(e,o,r)}};return n.$inject=["$scope","$element"],{restrict:"ECA",priority:100,transclude:!0,template:'<div class="angular-google-map" ng-transclude></div>',replace:!1,scope:{center:"=center",markers:"=markers",latitude:"=latitude",longitude:"=longitude",zoom:"=zoom",refresh:"&refresh",windows:"=windows",events:"=events"},controller:n,link:function(n,a,i){if(!angular.isDefined(n.center)||!angular.isDefined(n.center.latitude)||!angular.isDefined(n.center.longitude))return o.error("angular-google-maps: could not find a valid center property"),void 0;if(!angular.isDefined(n.zoom))return o.error("angular-google-maps: map zoom property not set"),void 0;angular.element(a).addClass("angular-google-map");var l={options:{}};i.options&&(l.options=angular.fromJson(i.options));var s=new t(angular.extend(l,{container:a[0],center:new google.maps.LatLng(n.center.latitude,n.center.longitude),draggable:"true"===i.draggable,zoom:n.zoom}));if(s.on("drag",function(){var e=s.center;r(function(){n.$apply(function(){n.center.latitude=e.lat(),n.center.longitude=e.lng()})})}),s.on("zoom_changed",function(){n.zoom!==s.zoom&&r(function(){n.$apply(function(){n.zoom=s.zoom})})}),s.on("center_changed",function(){var e=s.center;r(function(){n.$apply(function(){s.dragging||(n.center.latitude=e.lat(),n.center.longitude=e.lng())})})}),angular.isDefined(n.events))for(var c in n.events)n.events.hasOwnProperty(c)&&angular.isFunction(n.events[c])&&s.on(c,function(){n.events[c].apply(n,[s,c,arguments])});"true"===i.markClick&&function(){var e=null;s.on("click",function(t){if(null===e){if(e={latitude:t.latLng.lat(),longitude:t.latLng.lng()},void 0!==n.$parent.selectedItemIndex){var o=n.$parent.items[n.$parent.selectedItemIndex];void 0===o.pt&&(o.pt=[e.longitude,e.latitude],n.markers.push(e))}r(function(){e&&(n.latitude=e.latitude,n.longitude=e.longitude),n.$apply()})}e=null})}(),n.map=s,angular.isUndefined(n.refresh())?s.draw():n.$watch("refresh()",function(e,t){e&&!t&&s.draw()}),n.$watch("markers",function(t){r(function(){angular.forEach(t,function(e){s.hasMarker(e.latitude,e.longitude,e.draggable)||s.addMarker(e.latitude,e.longitude,e.icon,e.mkrNo,e.mkrState,e.infoWindow,e.label,e.url,e.thumbnail,e.draggable)});var o=[];angular.forEach(s.getMarkerInstances(),function(t){for(var r=t.getPosition(),a=r.lat(),i=r.lng(),l=!1,s=0;n.markers.length>s;s++){var c=n.markers[s];e(c.latitude,a)&&e(c.longitude,i)&&(l=!0)}l||o.push(t)}),"true"===i.fit&&t&&t.length>1&&s.fit()})},!0),n.$watch("center",function(e,t){e!==t&&(s.dragging||(s.center=new google.maps.LatLng(e.latitude,e.longitude),s.draw()))},!0),n.$watch("zoom",function(e,t){e!==t&&(s.zoom=e,s.draw())})}}}])}(),angular.module("ofApp").controller("MainCtrl",["$scope","Restangular",function(e,t){var o=t.all("plcs");e.plcs=o.getList()}]),angular.module("ofApp").controller("PlcsCtrl",["$rootScope","$scope","$location","$routeParams","Restangular","$timeout","$log","$anchorScroll",function(e,t,o,r,n,a,i,l){var s={latitude:9.988002927,longitude:-84.20538052916},c=s;angular.extend(t,{position:{coords:c},centerProperty:c,zoomProperty:13,markersProperty:[{latitude:c.latitude,longitude:c.longitude,draggable:!0,mkrNo:6,mkrState:0}],clickedLatitudeProperty:null,clickedLongitudeProperty:null,eventsProperty:{click:function(e,t,o){i.log("user defined event on map directive with scope",this),i.log("user defined event: "+t,e,o)}}}),t.itemMkrClick=function(e){if(t.selectedItemIndex=e,void 0!==t.items[e].pt){var r=t.items[e].pt;t.position.coords={latitude:r[1],longitude:r[0]}}o.hash("top"),l()};var u={ll:s,cngSlug:"crherbs",cngAreaSlug:"crherbsca",cngAreaTerrSlug:"crherbsca12",q:"",sort:"bdry,w",filter:"cngAreaTerr:crherbs",pp:5,pg:5};t.items=[],t.lastItemsWithInfo=null,t.maxId=null,t.q=r.q||u.q,t.pp=r.pp||u.pp,t.pg=r.pg||u.pg,t.sort=r.sort||u.sort,t.args=u,t.cngs=[{slug:"crherbs",nam:"Belen Sur"}],t.cngAreas=[{bdry:"crherbs",slug:"crherbsca",nam:"Cariari"},{bdry:"crherbs",slug:"crherbsla",nam:"Los Arcos"}],t.cngAreaTerrs=[{bdry:"crherbsca",slug:"crherbsca01",nam:"CA-01 (bogus)"},{bdry:"crherbsca",slug:"crherbsca12",nam:"CA-12"},{bdry:"crherbsla",slug:"crherbsla01",nam:"LA-01 (bogus)"},{bdry:"crherbsla",slug:"crherbsla02",nam:"LA-02 (bogus)"}],r.sort||(r.sort=u.sort),e.returnRoute=o.$$url,t.location=o,t.routeParams=r,t.$watch("cngAreaTerrId",function(e){o.search("cngAreaTerrId",e),t.cngAreaTerrId=e}),t.$watch("routeParams",function(e){return angular.forEach(e,function(e,r){return"where"!==r?(t[r]=e,o.search(r,e)):void 0})},!0);var g=n.all("plcs");t.doClear=function(){t.q=t.location.q=t.routeParams.q=u.q,t.doSearch()},t.doSearch=function(){var e={},n=t.q,a={};"boolean"!=typeof r.cngAreaTerrId&&r.cngAreaTerrId&&(a.bdry=r.cngAreaTerrId);var i=n.match(/qp\w+/g);if(i){for(var l=[],s=0;i.length>s;++s)console.log(i[s]),l.push(i[s].substr(2));a.id={$in:l},n=n.replace(/qp\w+\s*/g,"")}n&&(a.dNam={$regex:n,$options:"i"}),console.log("whereParts",a),a&&(e.where=JSON.stringify(a)),r.sort&&(e.sort=r.sort),g.getList(e).then(function(e){t.items=e._items,t.q&&o.search("q",t.q)},function(){console.log("Oops error from server :(")})},t.add=function(){var e="doc="+JSON.stringify(t.newItem),o=n.all("plcs");o.post(e).then(function(e){t.newItem._id=e.doc._id,t.items.push(t.newItem),t.newItem={},t.myForm.$setPristine(),t.myForm.$pristine=!0})},t.remove=function(e){var a=confirm("Are you absolutely sure you want to delete?");if(a){var i=t.items[e],l=n.one("plcs",i._id);l.remove().then(function(){t.items.splice(e,1)},function(){return console.log("Oops error from server :("),o.path("/plc/"+r.id)})}},t.insert=function(){return o.path("/plc/insert")},t.edit=function(e){var r=t.items[e];return o.path("/plc/"+r._id+"/edit")},t.view=function(e){var r=t.items[e];return o.path("/plc/"+r._id)},t.doSearch()}]).controller("PlcFormCtrl",["$rootScope","$scope","$location","$routeParams","Restangular",function(e,t,o,r,n){var a="/plc/insert"===o.$$path;if(a)t.mode="Add New";else{t.mode="Update";var i=n.one("plcs",r.id);i.get().then(function(e){t.dNam=e.dNam,t.item={},t.item._id=e._id||null,t.item.bdry=e.bdry||"",t.item.nam=e.nam||"",t.item.namS=e.namS||"",t.item.addr=e.addr,t.item.desc=e.desc,t.item.tags=void 0!==e.tags?e.tags.join(","):"",void 0!==e.pt&&(t.item.lng=e.pt[0],t.item.lat=e.pt[1])},function(){console.log("Oops error from server :(")})}t.remove=function(e){var t=confirm("Are you absolutely sure you want to delete?");if(t){var a=n.one("plcs",e._id);a.remove().then(function(){return o.path("/plcs")},function(){return console.log("Oops error from server :("),o.path("/plc/"+r.id)})}},t.save=function(t){var o={};if(console.log("save"),a){o="doc="+JSON.stringify(t);var r=n.all("plcs");r.post(o).then(function(){window.location.href="#"+e.returnRoute},function(){console.log("Oops error from server :(")})}else t.tags=void 0!==t.tags&&t.tags>""?t.tags.split(","):[],void 0!==t.lng&&void 0!==t.lat&&(t.pt=[t.lng,t.lat],delete t.lat,delete t.lng),delete t._id,console.log("item",t),o=JSON.stringify({actions:{$set:{flds:t}}}),i.customPUT(void 0,void 0,void 0,o).then(function(){window.location.href="#"+e.returnRoute},function(){console.log("Oops error from server :(")})},t.abandonChanges=function(){return o.path("/plc/"+t.item._id)}}]).controller("PlcViewCtrl",["$rootScope","$scope","$location","$routeParams","Restangular",function(e,t,o,r,n){var a=n.one("plcs",r.id);a.get().then(function(e){t.item=e,void 0!==e.pt&&(t.lng=e.pt[0],t.lat=e.pt[1])},function(){console.log("Oops error from server :(")}),t.remove=function(t){var o=confirm("Are you absolutely sure you want to delete?");if(o){var r=n.one("plcs",t._id);r.remove().then(function(){window.location.href="#"+e.returnRoute},function(){console.log("Oops error from server :("),window.location.href="#"+e.returnRoute})}},t.edit=function(e){return o.path("/plc/"+e._id+"/edit")}}]);