"use strict";angular.module("ModelCore",["ng"]).factory("ModelCore",["$http","$q","$filter",function(t,e,n){t.defaults.useXDomain=!0;var r=function r(){this.$init.apply(this,arguments)};return r.prototype={$uuid:null,$pkField:null,$settings:{},$mapping:{},$dataset:[],$init:function(){var t=this;t.$settings=angular.extend({headers:{"Content-Type":"application/json"},dataField:{one:"content",many:"items"},urls:{base:null}},t.$settings),t.$uuid=r.getUUID()},$offline:!1,$fetch:function(){return this.next()},$incremental:function(t,e){return this.$find(t,e,!0)},$find:function(t,e,n){var r=this;return n=void 0===n||0==n?!1:!0,r.$call({url:r.$url("get"),method:"GET"},r,t).success(function(t){return n!==!0&&(r.$dataset=[]),r.$parse(t)})},$delete:function(){var t=this;return t.$settings.headers={"Content-Type":"application/json",Authorization:"Basic admin@orgtec.com:xxxxxx"},t.$call({url:t.$url("delete"),method:"DELETE",data:t.$toObject()},t).success(function(){r.destroy(t)})},$get:function(t){var e=this;e.$settings.headers={"Content-Type":"application/json",Authorization:"Basic admin@orgtec.com:xxxxxx"};var r={};return r._id=t,e.$call({url:e.$url("get",r),method:"GET"},e).success(function(r){return e.$dataset=[],e.$parse(r),e.$dataset=1==e.$dataset.length?e.$dataset:n("filter")(e.$dataset,function(e){return e._id==t?e:void 0}),e.$dataset})},$getById:function(t){var e=this;return console.log("getById"),e.$settings.headers={"Content-Type":"application/json",Authorization:"Basic admin@orgtec.com:xxxxxx"},e.$call({url:e.$url("getById",t),method:"GET"},e).success(function(t){return e.$dataset=[],e.$parse(t),t[0]})},$put:function(){var t=this;return t.$call({url:t.$url("put"),method:"PUT",data:t.$toObject()},t).success(function(){var e,n=t.$toObject();for(e in n)t.__proto__[e]=n[e]})},$save:function(){var t=this;return t.$call({url:t.$url("post"),method:"POST",data:t.$toObject()},t).success(function(){var e,n=t.$toObject();for(e in n)t.__proto__[e]=n[e]})},$toObject:function(){var t,e=this,n={};for(t in e.$mapping)n[t]=e[t];return n},$original:function(){var t,e=this,n={};for(t in e.$mapping)n[t]=e.__proto__[t];return n},$isChanged:function(t){var e=this,n=e.$diff();return void 0===t?Object.keys(n).length>0?!0:!1:n[t]?n[t]?!0:!1:void 0},$diff:function(t,e){var n=this,r={};t=void 0===t?n.$original():t,e=void 0===e?n.$toObject():e;for(var o in e)if(!t||t[o]!==e[o])if("object"==typeof e[o]){var i=n.$diff(t[o],e[o]);n.isEmpty(i)||(r[o]=i)}else r[o]=e[o];return r},$call:function(t,e,n){var o=this;return o.$offline?r.callOffline(t,e,n):r.call(t,e,n)},$parse:function(t){var e=this;return e.$dataset=e.$dataset.concat(r.parse(t,e))},__cursor:0,next:function(){var t=this,e=t.__cursor;return t.__cursor++,t.$goTo(e)},prev:function(){var t=this,e=t.__cursor;return t.__cursor--,t.$goTo(e)},$goTo:function(t){var e=this;if(e.__cursor>e.$dataset.length)return e.__cursor=0,!1;if(0>e.__cursor)return e.__cursor=0,!1;var n=null;e.$mapping=e.$dataset[t].$mapping;for(n in e.$dataset[t].$toObject())e[n]=e.$dataset[t][n];return e.$dataset[t]},$url:function(t,e){var n=this,r=void 0===n.$settings.urls[t]||null==n.$settings.urls[t]?n.$settings.urls.base:n.$settings.urls[t];if("getById"===t)return r+="/"+e;if(null==r||void 0===r)throw"Model URL missing for "+typeof n+" in ["+t+"].";var o,i=/(:[A-z]+\/?)/g,a=r.match(i);for(o in a){var s=a[o].replace("/",""),u=s.replace(":","");r=e&&void 0!==e[u]?r.replace(s,e[u]):r.replace(a[o],"")}return r}},r.destroy=function(t){var e=t.$parentModel.$dataset.indexOf(t);t.$parentModel.$dataset.splice(e,1)},r.call=function(e,n,r){if(void 0===e&&(e={}),!e.method)throw"You must setup a method";if(!e.url)throw"You must setup an url";return r&&(e.params=r),"DELETE"===e.method&&(e.url+="/"+e.data._id,e.data={}),e.headers=n.$settings.headers,t(e)},r.__call=function(t,n){var r=e.defer(),o="_ModelCoreOfflineData";if("undefined"!=typeof Storage){var i={},a=sessionStorage.getItem(o);void 0===a&&(sessionStorage.setItem(o,"{}"),a=sessionStorage.getItem(o)),a=JSON.parse(a),i.calls[t.method]={options:t,uuid:n.$uuid},angular.extend(a,i),sessionStorage.setItem(o,JSON.stringify(i)),r.resolve(n)}else r.reject("Error processing offline call: "+(""+i));return r.promise},r.parse=function(t,e){var n=t[e.$settings.dataField.one]?[t[e.$settings.dataField.one]]:t[e.$settings.dataField.many];void 0===n&&(n=n instanceof Array?t:[t]);var o,i=function(t){return angular.extend(t,e),r.instance(t,e)},a=[];for(o in n){var s;n[o].$mapping={};for(s in n[o])"$mapping"!=s&&(n[o].$mapping[s]=!0);n[o].$parentModel=e,a.push(new(new i(n[o])()))}return a},r.instance=function(t,e){var n,r=window._ModelCoreConstructor=this,o=e?e.$type:t.$type;n=Function("return function "+o+"(settings) { window._ModelCoreConstructor.apply(this,arguments) }")();var i=function(){this.$__construct=n};return i.prototype=r.prototype,n.prototype=new i,e&&angular.extend(n.prototype,e.__proto__),t&&angular.extend(n.prototype,t),angular.extend(n,r,e),n.__super__=r.prototype,n},r.urlencode=function(t){return t=""+(t+""),encodeURIComponent(t).replace(/!/g,"%21").replace(/'/g,"%27").replace(/\(/g,"%28").replace(/\)/g,"%29").replace(/\*/g,"%2A").replace(/%20/g,"+")},r.buildQuery=function(t,e,n){var r,o,i=[],a=this,s=function(t,e,n){var r,o=[];if(e===!0?e="1":e===!1&&(e="0"),null!=e){if("object"==typeof e){for(r in e)null!=e[r]&&o.push(s(t+"["+r+"]",e[r],n));return o.join(n)}if("function"!=typeof e)return a.urlencode(t)+"="+a.urlencode(e);throw Error("There was an error processing for http_build_query().")}return""};n||(n="&");for(o in t){r=t[o],e&&!isNaN(o)&&(o=e+""+o);var u=s(o,r,n);""!==u&&i.push(u)}return i.join(n)},r.isEmpty=function(t){if(null==t)return!0;if("[object Array]"==toString.call(t)||"[object String]"==toString.call(t))return 0===t.length;for(var e in t)if(hasOwnProperty.call(t,e))return!1;return!0},r.getUUID=function(){for(var t=[],e="0123456789ABCDEF",n=0;36>n;n++)t[n]=Math.floor(16*Math.random());t[14]=4,t[19]=8|3&t[19];for(var n=0;36>n;n++)t[n]=e[t[n]];return t[8]=t[13]=t[18]=t[23]="-",t.join("")},r}]),angular.module("of5App",["ModelCore"]).constant("XCHGLAB_CONFIG",{API_KEY:"testkey"}).config(["$routeProvider",function(t){t.when("/",{templateUrl:"views/main.html",controller:"MainCtrl"}).when("/plcs",{templateUrl:"views/plcs.html",controller:"PlcsCtrl"}).when("/plc/:id/edit",{templateUrl:"views/plc-edit.html",controller:"PlcEditCtrl"}).when("/plc/:id",{templateUrl:"views/plc-view.html",controller:"PlcViewCtrl"}).otherwise({redirectTo:"/"})}]).factory("Plc",["xchglabResourceHttp",function(t){var e=t("plcs");return e.$put=function(){console.log("$put",this.etag),console.log("tkn",this.tkn)},e}]).factory("Plcs",["ModelCore",function(t){return t.instance({$type:"Plcs",$pkField:"_id",$settings:{dataField:{many:"_items"},urls:{base:"http://exi.xchg.com/api/plcs"}},$myCustomAction:function(t){console.log(t,this)}})}]).factory("User",["xchglabResourceHttp",function(t){return t("users")}]),angular.module("of5App").controller("MainCtrl",["$scope",function(){}]),angular.module("of5App").factory("xchglabResourceHttp",["XCHGLAB_CONFIG","$http",function(t,e){function n(n){var r=angular.extend({BASE_URL:"http://exi.xchg.com/api/"},t),o=r.BASE_URL+n,i={apiKey:r.API_KEY},i={};e.defaults.headers.common.Authorization="Basic admin@orgtec.com:xxxxxx";var a=function(t){return new l(t)},s=function(t){var e,n;if(null!=(null!=t?t._items:void 0)){for(n=[],e=0;t._items.length>e;)n.push(new l(t._items[e])),e++;t._items=n}return t},u=function(t,e,n,r){return t.then(function(t){var n=r(t.data);return(e||angular.noop)(n,t.status,t.headers,t.config),n},function(t){return(n||angular.noop)(void 0,t.status,t.headers,t.config),void 0})},c=function(t){return angular.isObject(t)&&!angular.equals(t,{})?{where:JSON.stringify(t)}:{}},l=function(t){angular.extend(this,t)};return l.query=function(t,n,r,a){var l=function(t){var e={sort:"sort",max_results:"max_results",fields:"fields",skip:"skip",page:"page"},n={};return t&&!angular.equals(t,{})&&angular.forEach(e,function(e,r){angular.isDefined(t[r])&&(n[e]=angular.isObject(t[r])?JSON.stringify(t[r]):t[r])}),n};angular.isFunction(n)&&(a=r,r=n,n={});var d=angular.extend({},i,c(t),l(n)),p=e.get(o,{params:d});return u(p,r,a,s)},l.all=function(t,e,n){return angular.isFunction(t)&&(n=e,e=t,t={}),l.query({},t,e,n)},l.count=function(t,n,r){var a=e.get(o,{params:angular.extend({},i,c(t),{c:!0})});return u(a,n,r,function(t){return t})},l.distinct=function(t,r,o,a){var s=e.post(dbUrl+"/runCommand",angular.extend({},r||{},{distinct:n,key:t}),{params:i});return u(s,o,a,function(t){return t.values})},l.getById=function(t,n,r){var s=e.get(o+"/"+t,{params:i});return u(s,n,r,a)},l.getByObjectIds=function(t,e,n){var r=[];return angular.forEach(t,function(t){r.push({$oid:t})}),l.query({_id:{$in:r}},e,n)},l.prototype.$id=function(){return this._id&&this._id.$oid?this._id.$oid:this._id?this._id:void 0},l.prototype.$save=function(t,n){var r=e.post(o,this,{params:i});return u(r,t,n,a)},l.prototype.$update=function(t,n){var r=e.put(o+"/"+this.$id(),angular.extend({},this,{_id:void 0}),{params:i});return u(r,t,n,a)},l.prototype.$remove=function(t,n){var r=e["delete"](o+"/"+this.$id(),{params:i});return u(r,t,n,a)},l.prototype.$saveOrUpdate=function(t,e,n,r){return this.$id()?this.$update(e,r):this.$save(t,n)},l}return n}]),angular.module("of5App").controller("PlcEditCtrl",["$scope","$location","$routeParams","Plcs","Plc","User",function(t,e,n,r,o){t.Plcs=new r,t.init=function(){t.Plcs.$getById(n.id).success(function(e){var n=t.Plcs.$fetch();t.raw=e,t.item=n,t.lat=n.pts[0],t.lng=n.pts[1]})},t.init();var i,a;t.put=function(){var e;return console.log("PlcEditCtrl.put"),e={$set:{flds:{lbl:t.plc.lbl}}},o.put(JSON.stringify({actions:e}),a,i)},a=function(){return e.path("/plcs")},i=function(){throw Error("Something went wrong...")},t.abandonChanges=function(){return e.path("/plc/"+t.item._id)}}]).controller("PlcsCtrl",["$scope","$location","$routeParams","Plcs","Plc",function(t,e,n,r){t.Plcs=new r,t.init=function(){console.log("PlcsCtrl"),t.Plcs.$find({where:{},max_results:10}).success(function(e){console.log("PlcsCtrl.items",e._items),t.items=e._items})},t.init(),t.edit=function(t){return e.path("/plc/"+t._id+"/edit")},t.view=function(t){return e.path("/plc/"+t._id)}}]).controller("PlcViewCtrl",["$scope","$routeParams","Plcs","Plc","User",function(t,e,n){t.Plcs=new n,t.init=function(){t.Plcs.$getById(e.id).success(function(e){var n=t.Plcs.$fetch();t.raw=e,t.item=n,t.lat=n.pts[0],t.lng=n.pts[1]})},t.init()}]);