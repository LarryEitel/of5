"use strict";angular.module("ModelCore",["ng"]).factory("ModelCore",["$http","$q","$filter",function(t,n,e){t.defaults.useXDomain=!0;var r=function r(){this.$init.apply(this,arguments)};return r.prototype={$uuid:null,$pkField:null,$settings:{},$mapping:{},$dataset:[],$init:function(){var t=this;t.$settings=angular.extend({headers:{"Content-Type":"application/json"},dataField:{one:"content",many:"items"},urls:{base:null}},t.$settings),t.$uuid=r.getUUID()},$offline:!1,$fetch:function(){return this.next()},$incremental:function(t,n){return this.$find(t,n,!0)},$find:function(t,n,e){var r=this;return e=void 0===e||0==e?!1:!0,r.$call({url:r.$url("get"),method:"GET"},r,t).success(function(t){return e!==!0&&(r.$dataset=[]),r.$parse(t)})},$delete:function(){var t=this;return t.$settings.headers={"Content-Type":"application/json",Authorization:"Basic admin@orgtec.com:xxxxxx"},t.$call({url:t.$url("delete"),method:"DELETE",data:t.$toObject()},t).success(function(){r.destroy(t)})},$get:function(t){var n=this;n.$settings.headers={"Content-Type":"application/json",Authorization:"Basic admin@orgtec.com:xxxxxx"};var r={};return r._id=t,n.$call({url:n.$url("get",r),method:"GET"},n).success(function(r){return n.$dataset=[],n.$parse(r),n.$dataset=1==n.$dataset.length?n.$dataset:e("filter")(n.$dataset,function(n){return n._id==t?n:void 0}),n.$dataset})},$getById:function(t){var n=this;return console.log("getById"),n.$settings.headers={"Content-Type":"application/json",Authorization:"Basic admin@orgtec.com:xxxxxx"},n.$call({url:n.$url("getById",t),method:"GET"},n).success(function(t){return n.$dataset=[],n.$parse(t),t[0]})},$put:function(){var t=this;return t.$call({url:t.$url("put"),method:"PUT",data:t.$toObject()},t).success(function(){var n,e=t.$toObject();for(n in e)t.__proto__[n]=e[n]})},$save:function(){var t=this;return t.$call({url:t.$url("post"),method:"POST",data:t.$toObject()},t).success(function(){var n,e=t.$toObject();for(n in e)t.__proto__[n]=e[n]})},$toObject:function(){var t,n=this,e={};for(t in n.$mapping)e[t]=n[t];return e},$original:function(){var t,n=this,e={};for(t in n.$mapping)e[t]=n.__proto__[t];return e},$isChanged:function(t){var n=this,e=n.$diff();return void 0===t?Object.keys(e).length>0?!0:!1:e[t]?e[t]?!0:!1:void 0},$diff:function(t,n){var e=this,r={};t=void 0===t?e.$original():t,n=void 0===n?e.$toObject():n;for(var o in n)if(!t||t[o]!==n[o])if("object"==typeof n[o]){var i=e.$diff(t[o],n[o]);e.isEmpty(i)||(r[o]=i)}else r[o]=n[o];return r},$call:function(t,n,e){var o=this;return o.$offline?r.callOffline(t,n,e):r.call(t,n,e)},$parse:function(t){var n=this;return n.$dataset=n.$dataset.concat(r.parse(t,n))},__cursor:0,next:function(){var t=this,n=t.__cursor;return t.__cursor++,t.$goTo(n)},prev:function(){var t=this,n=t.__cursor;return t.__cursor--,t.$goTo(n)},$goTo:function(t){var n=this;if(n.__cursor>n.$dataset.length)return n.__cursor=0,!1;if(0>n.__cursor)return n.__cursor=0,!1;var e=null;n.$mapping=n.$dataset[t].$mapping;for(e in n.$dataset[t].$toObject())n[e]=n.$dataset[t][e];return n.$dataset[t]},$url:function(t,n){var e=this,r=void 0===e.$settings.urls[t]||null==e.$settings.urls[t]?e.$settings.urls.base:e.$settings.urls[t];if("getById"===t)return r+="/"+n;if(null==r||void 0===r)throw"Model URL missing for "+typeof e+" in ["+t+"].";var o,i=/(:[A-z]+\/?)/g,a=r.match(i);for(o in a){var s=a[o].replace("/",""),u=s.replace(":","");r=n&&void 0!==n[u]?r.replace(s,n[u]):r.replace(a[o],"")}return r}},r.destroy=function(t){var n=t.$parentModel.$dataset.indexOf(t);t.$parentModel.$dataset.splice(n,1)},r.call=function(n,e,r){if(void 0===n&&(n={}),!n.method)throw"You must setup a method";if(!n.url)throw"You must setup an url";return r&&(n.params=r),"DELETE"===n.method&&(n.url+="/"+n.data._id,n.data={}),n.headers=e.$settings.headers,t(n)},r.__call=function(t,e){var r=n.defer(),o="_ModelCoreOfflineData";if("undefined"!=typeof Storage){var i={},a=sessionStorage.getItem(o);void 0===a&&(sessionStorage.setItem(o,"{}"),a=sessionStorage.getItem(o)),a=JSON.parse(a),i.calls[t.method]={options:t,uuid:e.$uuid},angular.extend(a,i),sessionStorage.setItem(o,JSON.stringify(i)),r.resolve(e)}else r.reject("Error processing offline call: "+(""+i));return r.promise},r.parse=function(t,n){var e=t[n.$settings.dataField.one]?[t[n.$settings.dataField.one]]:t[n.$settings.dataField.many];void 0===e&&(e=e instanceof Array?t:[t]);var o,i=function(t){return angular.extend(t,n),r.instance(t,n)},a=[];for(o in e){var s;e[o].$mapping={};for(s in e[o])"$mapping"!=s&&(e[o].$mapping[s]=!0);e[o].$parentModel=n,a.push(new(new i(e[o])()))}return a},r.instance=function(t,n){var e,r=window._ModelCoreConstructor=this,o=n?n.$type:t.$type;e=Function("return function "+o+"(settings) { window._ModelCoreConstructor.apply(this,arguments) }")();var i=function(){this.$__construct=e};return i.prototype=r.prototype,e.prototype=new i,n&&angular.extend(e.prototype,n.__proto__),t&&angular.extend(e.prototype,t),angular.extend(e,r,n),e.__super__=r.prototype,e},r.urlencode=function(t){return t=""+(t+""),encodeURIComponent(t).replace(/!/g,"%21").replace(/'/g,"%27").replace(/\(/g,"%28").replace(/\)/g,"%29").replace(/\*/g,"%2A").replace(/%20/g,"+")},r.buildQuery=function(t,n,e){var r,o,i=[],a=this,s=function(t,n,e){var r,o=[];if(n===!0?n="1":n===!1&&(n="0"),null!=n){if("object"==typeof n){for(r in n)null!=n[r]&&o.push(s(t+"["+r+"]",n[r],e));return o.join(e)}if("function"!=typeof n)return a.urlencode(t)+"="+a.urlencode(n);throw Error("There was an error processing for http_build_query().")}return""};e||(e="&");for(o in t){r=t[o],n&&!isNaN(o)&&(o=n+""+o);var u=s(o,r,e);""!==u&&i.push(u)}return i.join(e)},r.isEmpty=function(t){if(null==t)return!0;if("[object Array]"==toString.call(t)||"[object String]"==toString.call(t))return 0===t.length;for(var n in t)if(hasOwnProperty.call(t,n))return!1;return!0},r.getUUID=function(){for(var t=[],n="0123456789ABCDEF",e=0;36>e;e++)t[e]=Math.floor(16*Math.random());t[14]=4,t[19]=8|3&t[19];for(var e=0;36>e;e++)t[e]=n[t[e]];return t[8]=t[13]=t[18]=t[23]="-",t.join("")},r}]),angular.module("of5App",["ModelCore"]).constant("XCHGLAB_CONFIG",{API_KEY:"testkey"}).config(["$routeProvider",function(t){t.when("/",{templateUrl:"views/main.html",controller:"MainCtrl"}).when("/plcs",{templateUrl:"views/plcs.html",controller:"PlcsCtrl"}).when("/plc/:id/edit",{templateUrl:"views/plc-edit.html",controller:"PlcEditCtrl"}).when("/plc/:id",{templateUrl:"views/plc-view.html",controller:"PlcViewCtrl"}).otherwise({redirectTo:"/"})}]).factory("Plc",["xchglabResourceHttp",function(t){var n=t("plcs");return n.$put=function(){console.log("$put",this.etag),console.log("tkn",this.tkn)},n}]).factory("Plcs",["ModelCore",function(t){return t.instance({$type:"Plcs",$pkField:"_id",$settings:{dataField:{many:"_items"},urls:{base:"http://exi.xchg.com/api/plcs"}},$myCustomAction:function(t){console.log(t,this)}})}]).factory("User",["xchglabResourceHttp",function(t){return t("users")}]),angular.module("of5App").controller("MainCtrl",["$scope",function(){}]),angular.module("of5App").factory("xchglabResourceHttp",["XCHGLAB_CONFIG","$http",function(t,n){function e(e){var r=angular.extend({BASE_URL:"http://exi.xchg.com/api/"},t),o=r.BASE_URL+e,i={apiKey:r.API_KEY},i={};n.defaults.headers.common.Authorization="Basic admin@orgtec.com:xxxxxx";var a=function(t){return new l(t)},s=function(t){var n,e;if(null!=(null!=t?t._items:void 0)){for(e=[],n=0;t._items.length>n;)e.push(new l(t._items[n])),n++;t._items=e}return t},u=function(t,n,e,r){return t.then(function(t){var e=r(t.data);return(n||angular.noop)(e,t.status,t.headers,t.config),e},function(t){return(e||angular.noop)(void 0,t.status,t.headers,t.config),void 0})},c=function(t){return angular.isObject(t)&&!angular.equals(t,{})?{where:JSON.stringify(t)}:{}},l=function(t){angular.extend(this,t)};return l.query=function(t,e,r,a){var l=function(t){var n={sort:"sort",max_results:"max_results",fields:"fields",skip:"skip",page:"page"},e={};return t&&!angular.equals(t,{})&&angular.forEach(n,function(n,r){angular.isDefined(t[r])&&(e[n]=angular.isObject(t[r])?JSON.stringify(t[r]):t[r])}),e};angular.isFunction(e)&&(a=r,r=e,e={});var d=angular.extend({},i,c(t),l(e)),p=n.get(o,{params:d});return u(p,r,a,s)},l.all=function(t,n,e){return angular.isFunction(t)&&(e=n,n=t,t={}),l.query({},t,n,e)},l.count=function(t,e,r){var a=n.get(o,{params:angular.extend({},i,c(t),{c:!0})});return u(a,e,r,function(t){return t})},l.distinct=function(t,r,o,a){var s=n.post(dbUrl+"/runCommand",angular.extend({},r||{},{distinct:e,key:t}),{params:i});return u(s,o,a,function(t){return t.values})},l.getById=function(t,e,r){var s=n.get(o+"/"+t,{params:i});return u(s,e,r,a)},l.getByObjectIds=function(t,n,e){var r=[];return angular.forEach(t,function(t){r.push({$oid:t})}),l.query({_id:{$in:r}},n,e)},l.prototype.$id=function(){return this._id&&this._id.$oid?this._id.$oid:this._id?this._id:void 0},l.prototype.$save=function(t,e){var r=n.post(o,this,{params:i});return u(r,t,e,a)},l.prototype.$update=function(t,e){var r=n.put(o+"/"+this.$id(),angular.extend({},this,{_id:void 0}),{params:i});return u(r,t,e,a)},l.prototype.$remove=function(t,e){var r=n["delete"](o+"/"+this.$id(),{params:i});return u(r,t,e,a)},l.prototype.$saveOrUpdate=function(t,n,e,r){return this.$id()?this.$update(n,r):this.$save(t,e)},l}return e}]),angular.module("of5App").controller("PlcEditCtrl",["$scope","$location","$routeParams","Plcs","Plc","User",function(t,n,e,r,o){t.Plcs=new r,t.init=function(){t.Plcs.$getById(e.id).success(function(n){var e=t.Plcs.$fetch();t.raw=n,t.item=e,t.lat=e.pts[0],t.lng=e.pts[1]})},t.init();var i,a;t.put=function(){var n;return console.log("PlcEditCtrl.put"),n={$set:{flds:{lbl:t.plc.lbl}}},o.put(JSON.stringify({actions:n}),a,i)},a=function(){return n.path("/plcs")},i=function(){throw Error("Something went wrong...")},t.abandonChanges=function(){return n.path("/plc/"+t.item._id)}}]).controller("PlcsCtrl",["$scope","$location","$routeParams","Plcs","Plc",function(t,n,e,r){t.Plcs=new r,t.init=function(){t.Plcs.$find({where:{},max_results:10}).success(function(n){console.log("PlcsCtrl.raw",n),t.raw=n;var e=t.Plcs.$fetch();t.plcs=e})},t.init(),t.edit=function(t){return n.path("/plc/"+t._id+"/edit")},t.view=function(t){return n.path("/plc/"+t._id)}}]).controller("PlcViewCtrl",["$scope","$routeParams","Plcs","Plc","User",function(t,n,e){t.Plcs=new e,t.init=function(){t.Plcs.$getById(n.id).success(function(n){var e=t.Plcs.$fetch();t.raw=n,t.item=e,t.lat=e.pts[0],t.lng=e.pts[1]})},t.init()}]);