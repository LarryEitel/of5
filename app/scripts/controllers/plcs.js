// Generated by CoffeeScript 1.6.2
(function() {
  "use strict";  angular.module("ofApp").controller("PlcsCtrl", [
    "$rootScope", "$scope", "$location", "$routeParams", "Restangular", "$timeout", "$log", "$anchorScroll", "GoogleMap", function($rootScope, $scope, $location, $routeParams, Restangular, $timeout, $log, $anchorScroll, GoogleMap) {
      var Plcs, defaultRouteArgs, qry;

      defaultRouteArgs = {
        cngSlug: "crherbs",
        cngAreaSlug: "crherbsca",
        cngAreaTerrSlug: "crherbsca12",
        q: "",
        sort: "bdry,w",
        filter: "cngAreaTerr:crherbs",
        z: 18,
        pp: 5,
        pg: 5
      };
      $scope.items = [];
      $scope.lastItemsWithInfo = null;
      $scope.maxId = null;
      $scope.q = $routeParams.q || defaultRouteArgs.q;
      $scope.ll = $routeParams.ll || defaultRouteArgs.ll;
      $scope.z = parseInt($routeParams.z, 10) || defaultRouteArgs.z;
      $scope.pp = $routeParams.pp || defaultRouteArgs.pp;
      $scope.pg = $routeParams.pg || defaultRouteArgs.pg;
      $scope.sort = $routeParams.sort || defaultRouteArgs.sort;
      $scope.args = defaultRouteArgs;
      $scope.cngs = [
        {
          slug: "crherbs",
          nam: "Belen Sur"
        }
      ];
      $scope.cngAreas = [
        {
          bdry: "crherbs",
          slug: "crherbsca",
          nam: "Cariari"
        }
      ];
      $scope.cngAreaTerrs = [
        {
          bdry: "crherbsca",
          slug: "crherbsca12",
          nam: "CA-12"
        }
      ];
      if (!$routeParams.sort) {
        $routeParams.sort = defaultRouteArgs.sort;
      }
      $rootScope.returnRoute = $location.$$url;
      $scope.location = $location;
      $scope.routeParams = $routeParams;
      $scope.$watch("z", function(newValue) {
        $location.search("z", newValue);
        return $scope.z = parseInt(newValue, 10);
      });
      $scope.$watch("cngAreaTerrId", function(newValue) {
        $location.search("cngAreaTerrId", newValue);
        return $scope.cngAreaTerrId = newValue;
      });
      $scope.$watch("routeParams", (function(newVal, oldVal) {
        return angular.forEach(newVal, function(v, k) {
          if (k !== "where") {
            $scope[k] = v;
            return $location.search(k, v);
          }
        });
      }), true);
      Plcs = Restangular.all("plcs");
      qry = {};
      $scope.doClear = function() {
        $scope.q = $scope.location.q = $scope.routeParams.q = defaultRouteArgs.q;
        return $scope.doSearch();
      };
      $scope.doSearch = function() {
        var args, errorCallback, i, plcIds, q, quickFindPlcIds, whereParts;

        args = {};
        q = $scope.q;
        whereParts = {};
        if (typeof $routeParams.cngAreaTerrId !== "boolean" && $routeParams.cngAreaTerrId) {
          whereParts.bdry = $routeParams.cngAreaTerrId;
        }
        quickFindPlcIds = q.match(/qp\w+/g);
        if (quickFindPlcIds) {
          plcIds = [];
          i = 0;
          while (i < quickFindPlcIds.length) {
            console.log(quickFindPlcIds[i]);
            plcIds.push(quickFindPlcIds[i].substr(2));
            ++i;
          }
          whereParts.id = {
            $in: plcIds
          };
          q = q.replace(/qp\w+\s*/g, "");
        }
        if (q) {
          whereParts.dNam = {
            $regex: q,
            $options: "i"
          };
        }
        if (whereParts) {
          args.where = JSON.stringify(whereParts);
        }
        if ($routeParams.sort) {
          args.sort = $routeParams.sort;
        }
        return Plcs.getList(args).then((function(items) {
          $scope.items = items._items;
          if ($scope.q) {
            return $location.search("q", $scope.q);
          }
        }), errorCallback = function() {
          return console.log("Oops error from server :(");
        });
      };
      $scope.add = function() {
        var data;

        data = "doc=" + JSON.stringify($scope.newItem);
        Plcs = Restangular.all("plcs");
        return Plcs.post(data).then(function(itemAdded) {
          $scope.newItem._id = itemAdded.doc._id;
          $scope.items.push($scope.newItem);
          return $scope.newItem = {};
        });
      };
      $scope.remove = function($index) {
        var Plc, confirmRemove, errorCallback, item;

        confirmRemove = confirm("Are you absolutely sure you want to delete?");
        if (confirmRemove) {
          item = $scope.items[$index];
          Plc = Restangular.one("plcs", item._id);
          return Plc.remove().then((function() {
            return $scope.items.splice($index, 1);
          }), errorCallback = function() {
            console.log("Oops error from server :(");
            return $location.path("/plc/" + $routeParams.id);
          });
        }
      };
      $scope.insert = function() {
        return $location.path("/plc/insert");
      };
      $scope.edit = function($index) {
        var item;

        item = $scope.items[$index];
        return $location.path("/plc/" + item._id + "/edit");
      };
      return $scope.view = function($index) {
        var item;

        item = $scope.items[$index];
        return $location.path("/plc/" + item._id);
      };
    }
  ]);

  angular.module("ofApp").controller("PlcFormCtrl", [
    "$rootScope", "$scope", "$location", "$routeParams", "Restangular", function($rootScope, $scope, $location, $routeParams, Restangular) {
      var Plc, errorCallback, insertMode;

      insertMode = $location.$$path === "/plc/insert";
      if (insertMode) {
        $scope.mode = "Add New";
      } else {
        $scope.mode = "Update";
        Plc = Restangular.one("plcs", $routeParams.id);
        Plc.get().then((function(item) {
          $scope.dNam = item.dNam;
          $scope.item = {};
          $scope.item._id = item._id || null;
          $scope.item.bdry = item.bdry || "";
          $scope.item.nam = item.nam || "";
          $scope.item.namS = item.namS || "";
          $scope.item.addr = item.addr;
          $scope.item.desc = item.desc;
          if (typeof item.tags !== "undefined") {
            $scope.item.tags = item.tags.join(",");
          } else {
            $scope.item.tags = "";
          }
          if (typeof item.pt !== "undefined") {
            $scope.item.lng = item.pt[0];
            return $scope.item.lat = item.pt[1];
          }
        }), errorCallback = function() {
          return console.log("Oops error from server :(");
        });
      }
      $scope.remove = function(item) {
        var confirmRemove;

        confirmRemove = confirm("Are you absolutely sure you want to delete?");
        if (confirmRemove) {
          Plc = Restangular.one("plcs", item._id);
          return Plc.remove().then((function() {
            return $location.path("/plcs");
          }), errorCallback = function() {
            console.log("Oops error from server :(");
            return $location.path("/plc/" + $routeParams.id);
          });
        }
      };
      $scope.save = function(item) {
        var Plcs, data;

        data = {};
        console.log("save");
        if (insertMode) {
          data = "doc=" + JSON.stringify(item);
          Plcs = Restangular.all("plcs");
          return Plcs.post(data).then((function() {
            return window.location.href = "#" + $rootScope.returnRoute;
          }), errorCallback = function() {
            return console.log("Oops error from server :(");
          });
        } else {
          if (undefined !== item.tags && item.tags > "") {
            item.tags = item.tags.split(",");
          } else {
            item.tags = [];
          }
          if (undefined !== item.lng && undefined !== item.lat) {
            item.pt = [item.lng, item.lat];
            delete item.lat;
            delete item.lng;
          }
          delete item._id;
          console.log("item", item);
          data = JSON.stringify({
            actions: {
              $set: {
                flds: item
              }
            }
          });
          return Plc.customPUT(undefined, undefined, undefined, data).then((function(itemUpdated) {
            return window.location.href = "#" + $rootScope.returnRoute;
          }), errorCallback = function() {
            return console.log("Oops error from server :(");
          });
        }
      };
      return $scope.abandonChanges = function() {
        return $location.path("/plc/" + $scope.item._id);
      };
    }
  ]);

  angular.module("ofApp").controller("PlcViewCtrl", [
    "$rootScope", "$scope", "$location", "$routeParams", "Restangular", function($rootScope, $scope, $location, $routeParams, Restangular) {
      var Plc, errorCallback;

      Plc = Restangular.one("plcs", $routeParams.id);
      Plc.get().then((function(item) {
        $scope.item = item;
        if (undefined !== item.pt) {
          $scope.lng = item.pt[0];
          return $scope.lat = item.pt[1];
        }
      }), errorCallback = function() {
        return console.log("Oops error from server :(");
      });
      $scope.remove = function(item) {
        var confirmRemove;

        confirmRemove = confirm("Are you absolutely sure you want to delete?");
        if (confirmRemove) {
          Plc = Restangular.one("plcs", item._id);
          return Plc.remove().then((function() {
            return window.location.href = "#" + $rootScope.returnRoute;
          }), errorCallback = function() {
            console.log("Oops error from server :(");
            return window.location.href = "#" + $rootScope.returnRoute;
          });
        }
      };
      return $scope.edit = function(item) {
        return $location.path("/plc/" + item._id + "/edit");
      };
    }
  ]);

}).call(this);
